
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Management â€” Bread App</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .container { max-width: 900px; margin: 2rem auto; background:#fff; padding:1rem 1.5rem; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,.08);}
    table { width:100%; border-collapse: collapse; }
    th, td { padding:.6rem .5rem; border-bottom:1px solid #eee; text-align:left; }
    .row-actions button { margin-right:.5rem; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;}
    .btn { padding:.4rem .7rem; border:none; border-radius:6px; cursor:pointer; }
    .btn.primary { background:#1976d2; color:#fff;}
    .btn.warn { background:#c62828; color:#fff;}
    .btn.muted { background:#e0e0e0;}
    .inline { display:flex; gap:.5rem; }
    input, select { padding:.5rem; border:1px solid #ddd; border-radius:6px; }
    .error { color:#c62828; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>Users</h1>
      <div class="inline">
        <a class="btn muted" href="/">Home</a>
        <button class="btn" id="logoutBtn">Logout</button>
      </div>
    </div>

    <h3>Add user</h3>
    <div class="inline" style="margin-bottom:1rem;">
      <input id="newUsername" placeholder="username"/>
      <input id="newPassword" placeholder="password" type="password"/>
      <select id="newRole">
        <option value="user">user</option>
        <option value="admin">admin</option>
      </select>
      <button class="btn primary" id="addBtn">Add</button>
      <span class="error" id="addErr"></span>
    </div>

    <table id="tbl">
      <thead><tr><th>Username</th><th>Role</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="error" id="err"></div>
  </div>

  <script>
    async function ensureAdmin() {
      const me = await fetch('/api/me').then(r=>r.json());
      if (!me.user) { location.href = '/login.html'; return false; }
      if (me.user.role !== 'admin') { alert('Admins only'); location.href = '/'; return false; }
      return true;
    }
    async function loadUsers() {
      const res = await fetch('/api/users');
      if (!res.ok) {
        document.getElementById('err').textContent = 'Failed to load users';
        return;
      }
      const list = await res.json();
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      for (const u of list) {
        const tr = document.createElement('tr');
        tr.innerHTML = \`
          <td>\${u.username}</td>
          <td>
            <select data-username="\${u.username}" class="roleSel">
              <option \${u.role==='user'?'selected':''} value="user">user</option>
              <option \${u.role==='admin'?'selected':''} value="admin">admin</option>
            </select>
          </td>
          <td class="row-actions">
            <button class="btn" data-username="\${u.username}" data-action="resetPw">Reset PW</button>
            <button class="btn warn" data-username="\${u.username}" data-action="delete">Delete</button>
          </td>\`;
        tbody.appendChild(tr);
      }
    }

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      if (btn.id === 'addBtn') {
        const username = document.getElementById('newUsername').value.trim();
        const password = document.getElementById('newPassword').value;
        const role = document.getElementById('newRole').value;
        const res = await fetch('/api/users', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password, role }) });
        if (!res.ok) {
          const d = await res.json().catch(()=>({error:'Error'}));
          document.getElementById('addErr').textContent = d.error || 'Error';
        } else {
          document.getElementById('newUsername').value = '';
          document.getElementById('newPassword').value = '';
          await loadUsers();
        }
      }
      if (btn.dataset.action === 'delete') {
        const username = btn.dataset.username;
        if (confirm('Delete user '+username+'?')) {
          await fetch('/api/users/' + encodeURIComponent(username), { method:'DELETE' });
          await loadUsers();
        }
      }
      if (btn.dataset.action === 'resetPw') {
        const username = btn.dataset.username;
        const pw = prompt('New password for '+username+':');
        if (pw) {
          await fetch('/api/users/' + encodeURIComponent(username), { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ password: pw }) });
          alert('Password updated');
        }
      }
    });
    document.addEventListener('change', async (e) => {
      if (e.target.classList.contains('roleSel')) {
        const username = e.target.dataset.username;
        const role = e.target.value;
        await fetch('/api/users/' + encodeURIComponent(username), { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ role }) });
      }
    });
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/logout', { method:'POST' });
      location.href = '/login.html';
    });

    (async () => { if (await ensureAdmin()) { await loadUsers(); }})();
  </script>
</body>
</html>
